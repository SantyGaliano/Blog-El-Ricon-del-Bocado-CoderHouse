{% load static %}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{% block title %}El Rinc√≥n del Bocado{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>

    <!-- Estilos centralizados (con cache-busting) -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=20251017" />

    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <!-- =============== TOPBAR ROTATOR =============== -->
    <div id="topbar" class="topbar" role="region" aria-label="Novedades">
      <div id="tbBg" class="tb-bg tb-grad-0"></div>
      <div class="tb-shimmer" aria-hidden="true"></div>
      <div class="tb-inner">
        <div class="tb-badge">NUEVO</div>
        <div class="tb-icon" aria-hidden="true">‚ú®</div>
        <div class="tb-text-wrap">
          <div id="tbText" class="tb-text tb-enter">Bienvenido a El Rinc√≥n del Bocado ‚Äî nuevas recetas cada semana.</div>
        </div>
        <div id="tbDots" class="tb-dots" aria-hidden="true">
          <span class="tb-dot active"></span>
          <span class="tb-dot"></span>
          <span class="tb-dot"></span>
          <span class="tb-dot"></span>
          <span class="tb-dot"></span>
          <span class="tb-dot"></span>
        </div>
      </div>
      <div class="tb-bottom-glow" aria-hidden="true"></div>
    </div>

    <!-- =============== NAVBAR (FIXED + GLASS) =============== -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">
          <img src="{% static 'images/El Rinc√≥n Del Bocado.png' %}" alt="El Rinc√≥n Del Bocado" height="32" />
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-label="Abrir men√∫">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navMenu">
          {% with current_url=request.resolver_match.url_name|default:'' %}
          <ul class="navbar-nav ms-auto nav-modern" id="navModern">
            <!-- Barra activa deslizante -->
            <i class="nav-active-indicator" aria-hidden="true"></i>

            <li class="nav-item">
              <a class="nav-link modern-link {% if current_url == 'home' or current_url == 'recipes:home' %}is-active{% endif %}"
                 href="{% url 'home' %}"
                 aria-current="{% if current_url == 'home' or current_url == 'recipes:home' %}page{% endif %}">
                Inicio
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link modern-link {% if current_url == 'about' %}is-active{% endif %}"
                 href="{% url 'about' %}"
                 aria-current="{% if current_url == 'about' %}page{% endif %}">
                Acerca de
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link modern-link {% if current_url == 'recipe-list' or current_url == 'recipes:list' %}is-active{% endif %}"
                 href="{% url 'recipe-list' %}"
                 aria-current="{% if current_url == 'recipe-list' or current_url == 'recipes:list' %}page{% endif %}">
                Recetas
              </a>
            </li>

            {% if user.is_authenticated %}
              <li class="nav-item d-flex align-items-center">
                <a href="{% url 'profile' %}" class="nav-link p-0 d-flex align-items-center modern-link" style="gap:.5rem;">
                  {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" class="avatar-nav">
                  {% else %}
                    <img src="https://i.pravatar.cc/150?u={{ user.username }}" alt="{{ user.username }}" class="avatar-nav">
                  {% endif %}
                  <span class="d-none d-lg-inline">Perfil</span>
                </a>
              </li>
              <li class="nav-item">
                <form method="post" action="{% url 'logout' %}" class="m-0">{% csrf_token %}
                  <button type="submit" class="nav-link btn btn-link p-0 modern-link">Cerrar sesi√≥n</button>
                </form>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="nav-link modern-link {% if current_url == 'auth' or current_url == 'accounts:auth' %}is-active{% endif %}"
                   href="{% url 'auth' %}"
                   aria-current="{% if current_url == 'auth' or current_url == 'accounts:auth' %}page{% endif %}">
                  Iniciar sesi√≥n
                </a>
              </li>
            {% endif %}
          </ul>
          {% endwith %}
        </div>
      </div>
    </nav>

    {% block fullwidth_content %}{% endblock %}

    <div class="container content-container">
      {% if messages %}
        <div class="pt-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Se√±alamos que hay JS (oculta fallback de subrayado en desktop) -->
    <script>document.body.classList.add('has-js');</script>

    <!-- Topbar: l√≥gica de rotaci√≥n + seteo de --topbar-h -->
    <script>
      (function(){
        const topbar   = document.getElementById('topbar');
        const bg       = document.getElementById('tbBg');
        const textNode = document.getElementById('tbText');
        const dotsWrap = document.getElementById('tbDots');
        const dots     = dotsWrap ? Array.from(dotsWrap.children) : [];

        // 6 anuncios (texto + gradiente index)
        const items = [
          { text: '‚ú® Bienvenido a El Rinc√≥n del Bocado ‚Äî nuevas recetas cada semana.', grad: 0 },
          { text: 'üç≤ Comparte tu receta y gana tu medalla de Chef de la Comunidad.',   grad: 4 },
          { text: 'üì∏ Fotos en alta calidad: tus platos se ven mejor y reciben m√°s guardados.', grad: 2 },
          { text: 'üîé B√∫squedas potentes: encontr√° por nombre, dificultad o ingredientes.', grad: 1 },
          { text: '‚≠ê Guard√° tus favoritas y coc√≠nalas cuando quieras.',                grad: 3 },
          { text: '‚ö° Interfaz moderna y r√°pida ‚Äî hecha con amor en Django + Bootstrap.', grad: 5 }
        ];

        let idx = 0;
        let dir = 1; // 1 adelante, -1 atr√°s

        const setTopbarHeight = () => {
          const tb = (topbar && getComputedStyle(topbar).display !== 'none') ? topbar.offsetHeight : 0;
          document.documentElement.style.setProperty('--topbar-h', tb + 'px');
        };

        const applyDotState = () => {
          if (!dots.length) return;
          dots.forEach((d,i) => d.classList.toggle('active', i === idx));
        };

        const applyBg = () => {
          if (!bg) return;
          for (let i=0;i<6;i++) bg.classList.remove('tb-grad-'+i);
          bg.classList.add('tb-grad-'+items[idx].grad);
        };

        const switchText = (next) => {
          if (!textNode) return;
          const exiting = textNode.cloneNode(true);
          exiting.classList.remove('tb-enter');
          exiting.classList.add('tb-exit');
          if (dir === -1) exiting.classList.add('back');
          textNode.parentNode.appendChild(exiting);

          textNode.textContent = next.text;
          textNode.classList.remove('tb-exit','back');
          textNode.classList.add('tb-enter');
          if (dir === -1) textNode.classList.add('back');

          setTimeout(() => exiting.remove(), 380);
        };

        const goTo = (nextIndex) => {
          dir = (nextIndex > idx) ? 1 : -1;
          idx = (nextIndex + items.length) % items.length;
          switchText(items[idx]);
          applyBg();
          applyDotState();
        };

        // init
        applyBg();
        applyDotState();
        setTopbarHeight();
        window.addEventListener('resize', setTopbarHeight, { passive:true });

        // autoplay cada 4s
        setInterval(() => goTo(idx+1), 4000);
      })();
    </script>

    <!-- Navbar: indicador activo bajo el texto -->
    <script>
      (function(){
        const nav = document.getElementById('navModern');
        if (!nav) return;

        const indicator = nav.querySelector('.nav-active-indicator');
        const links = Array.from(nav.querySelectorAll('.modern-link'));
        const OFFSET = 6; // separaci√≥n bajo el texto (ajustada fina)

        const textRect = (el) => {
          const range = document.createRange();
          range.selectNodeContents(el);
          const rect = range.getBoundingClientRect();
          return rect.width ? rect : el.getBoundingClientRect();
        };

        const setIndicatorTo = (el) => {
          const navRect = nav.getBoundingClientRect();
          const r = textRect(el);
          const x = r.left - navRect.left;
          const w = r.width;
          const y = (r.bottom - navRect.top) + OFFSET;
          indicator.style.setProperty('--indicator-x', x + "px");
          indicator.style.setProperty('--indicator-w', w + "px");
          indicator.style.setProperty('--indicator-y', y + "px");
        };

        const active = links.find(a => a.getAttribute('aria-current') === 'page') || links[0];
        if (active) setIndicatorTo(active);

        links.forEach(link => link.addEventListener('mouseenter', () => setIndicatorTo(link)));
        nav.addEventListener('mouseleave', () => active && setIndicatorTo(active));
        window.addEventListener('resize', () => {
          const current = document.querySelector('.modern-link[aria-current="page"]') || active;
          if (current) setIndicatorTo(current);
        });
      })();
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
